generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String                  @id @default(cuid())
  clerkId       String                  @unique
  email         String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  subscriptions Subscription[]
  settings      UserSettings?
  snapshots     SubscriptionSnapshot[]
  vendorFeedback VendorLinkFeedback[]

  // Stripe Pro fields
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripeCurrentPeriodEnd DateTime?
  isPro                  Boolean   @default(false)
  proStatus              String    @default("FREE") // FREE, ACTIVE, PAST_DUE, CANCELED
}

model Subscription {
  id                String                 @id @default(cuid())
  name              String
  category          String
  secondaryCategory String?
  monthlyCost       Float
  usageFrequency    String
  importance        String
  roiScore          Int
  status            String
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  userId            String
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots         SubscriptionSnapshot[]

  // Billing cycle and renewal
  billingCycle         String    @default("monthly")
  renewalDate          DateTime?
  // Cancellation and usage scope
  cancellationFriction String    @default("moderate")
  usageScope           String    @default("personal")
  // Trial-specific fields
  trialEndDate         DateTime?
  trialReminderEnabled Boolean   @default(true)
  trialReminderDays    Int       @default(3)

  // Vendor cancel-link directory
  vendorId  String?
  vendor    Vendor?  @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  cancelUrl String?  // user-provided override

  @@unique([userId, name])
  @@index([userId])
}

model UserSettings {
  id                String  @id @default(cuid())
  pushNotifications Boolean @default(true)
  emailReports      Boolean @default(false)
  emailAddress      String  @default("")
  userId            String  @unique
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SubscriptionSnapshot {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  snapshotMonth String // "YYYY-MM" format
  monthlyCost   Float
  roiScore      Int
  status        String
  category      String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([subscriptionId, snapshotMonth])
  @@index([userId, snapshotMonth])
}

model Vendor {
  id             String               @id @default(cuid())
  name           String
  domain         String               @unique
  billingUrl     String?
  cancelHelpUrl  String?
  source         String               @default("curated") // curated | user_submitted
  confidence     String               @default("medium") // high | medium | low
  lastVerifiedAt DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  subscriptions Subscription[]
  feedback      VendorLinkFeedback[]

  @@index([name])
  @@index([domain])
}

model VendorLinkFeedback {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String   @default("open_billing_link")
  result    String // success | fail | skip
  createdAt DateTime @default(now())

  @@index([vendorId])
  @@index([userId])
}

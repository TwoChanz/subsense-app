generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String                  @id @default(cuid())
  clerkId       String                  @unique
  email         String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  subscriptions Subscription[]
  settings      UserSettings?
  snapshots     SubscriptionSnapshot[]

  // Stripe Pro fields
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripeCurrentPeriodEnd DateTime?
  isPro                  Boolean   @default(false)
  proStatus              String    @default("FREE") // FREE, ACTIVE, PAST_DUE, CANCELED
}

model Subscription {
  id                String                 @id @default(cuid())
  name              String
  category          String
  secondaryCategory String?
  monthlyCost       Float
  usageFrequency    String
  importance        String
  roiScore          Int
  status            String
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  userId            String
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots         SubscriptionSnapshot[]

  // Billing cycle and renewal
  billingCycle         String    @default("monthly")
  renewalDate          DateTime?
  // Cancellation and usage scope
  cancellationFriction String    @default("moderate")
  usageScope           String    @default("personal")
  // Trial-specific fields
  trialEndDate         DateTime?
  trialReminderEnabled Boolean   @default(true)
  trialReminderDays    Int       @default(3)

  @@unique([userId, name])
  @@index([userId])
}

model UserSettings {
  id                String  @id @default(cuid())
  pushNotifications Boolean @default(true)
  emailReports      Boolean @default(false)
  emailAddress      String  @default("")
  userId            String  @unique
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SubscriptionSnapshot {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  snapshotMonth String // "YYYY-MM" format
  monthlyCost   Float
  roiScore      Int
  status        String
  category      String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([subscriptionId, snapshotMonth])
  @@index([userId, snapshotMonth])
}
